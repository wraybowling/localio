<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<style>
		*{
			margin:0;
			padding:0;
			width:100%;
		}
	</style>
</head>

<body>

	<input id="timer" type="range"  value="50" min="0" max="200" onchange="setDelay(this.value)">
	<label for="timer">Delay</label>
	<input id="shift" type="range"  value="50" min="0" max="200" onchange="setShift(this.value)">
	<label for="shift">Shift</label>

	<p id="display_text"></p>


	<button onclick="speak('wray')">Speak as Wray</button>
	<button onclick="speak()">Speak again</button>

	<textarea id="source_text">Before I understood what it meant to be who I was, I certainly had a sense of what it meant to be somewhere. There were a lot of kids in my neighborhood that weren't that receptive to the concept of being a nice person. Every subject as a ten year old is a subject of war. Who can we go to war with? who can we destroy? I'm not saying that children inherintly understand the concept of war, but I am suggesting that they are mean.

What brings me back to this time over and over? I thought I had left this space. "The past is the past" right? Who's Localio am I sensing right now?

There's a diner up ahead. And a bike...

Anyway, the kid stuff maybe doesn't matter so much right now. We'll talk about that later. Maybe forget that I mentioned it, okay?</textarea>

	<script>
		// GUI
		var delay;
		var shift;

		function setDelay(new_value){
			delay = new_value;
			clearInterval(timer);
			timer = setInterval(setPlayhead, delay);
			console.log('delay:', delay, ' shift:',shift);
		}

		function setShift(new_value){
			shift = new_value;
			console.log('delay:', delay, ' shift:',shift);
		}

		// Web Audio
		function init(){
			try{
				window.AudioContext = window.AudioContext || window.webkitAudioContext;
				waapi = new AudioContext();
			}catch(error){
				console.error('Our dear friend WAAPI might not be supported.');
				console.error(error);
			}
		}
		init();

		function sample(){
			this.buffers = [];
		}

		sample.prototype.phonomesList = [
			'a','ah','ay','ai',
			'e','ea','ee',
			'i',
			'o','oe','oy',
			'u','uh',
			'sh',
			'qu','w','r','t','y','p','s','d','f','g','h','j','k','l','z','v','b','n','m'
		];

		sample.prototype.loadSound = function(url){
			var request = new XMLHttpRequest();
			request.open('GET',url,true);
			request.responseType = 'arraybuffer';

			var target = this;

			request.onload = function(){
				waapi.decodeAudioData(
					request.response
					,function(buffer){
						target.buffer = buffer;
						console.log('wrote buffer to',this);
					}
					,function(error){
						console.error(error);
					}
				);
			}

			request.send();
		};

		sample.prototype.play = function(){
			var source = waapi.createBufferSource();
			source.buffer = this.buffer;
			source.connect(waapi.destination);
			source.start(0);
		};

		// Text to speech processing
		var regex_syllables = /(sh|ch|wh|th|qu|es|[a-z])?[aeiouy]+/ig;
		var regex_consonants = /(sh|ch|wh|th|qu|es|[wrtpsdfghjklzxcvbmn])+/ig;
		var regex_vowels = /[aeiouy][aeiouy]?/ig;

		var source_text = document.getElementById('source_text');
		var syllables = source_text.textContent.match(regex_syllables);

//		console.log('syllables',syllables);

		function playback(){
			for (var i = 0; i < syllables.length; i++) {
				var consonant = syllables[i].match(regex_consonants);
				var vowel = syllables[i].match(regex_vowels);
				console.log(consonant,vowel);

				if(consonant === 'c'){ consonant = Math.round(Math.random()) ? 'k' : 's'; }
				else if(consonant === 'wh'){ consonant = 'w'; }
				else if(consonant === 'qu'){ consonant = 'k'; }
				else if(consonant === 'es'){ consonant = 'z'; }

				consonant_sample = new sample(consonant);

				if(vowel === 'i'){ vowel = Math.round(Math.random()) ? 'ee' : 'ai'; }

				vowel_sample = new sample(vowel);
				/*

				var consonant_sound = switch(consonant){
					case 'sh': load('sh'); break;
					case 'ch': load('ch'); break;
					case 'wh': load('w'); break;
					case 'th': load('th'); break;
					case 'qu': load('k'); break;
					case 'es': load('z'); break;
					case 'w': load('w'); break;
					case 'r': load('r'); break;
					case 't': load('t'); break;
					case 'p': load('p'); break;
					case 's': load('s'); break;
					case 'f': load('f'); break;
					case 'g': load('g'); break;
					case 'h': load('h'); break;
					case 'j': load('j'); break;
					case 'k': load('k'); break;
					case 'l': load('l'); break;
					case 'z': load('z'); break;
					case 'x': load('k'); break;
					case 'c': Math.round(Math.random()) ? load('k') : load('s'); break;
					case 'v': load('v'); break;
					case 'n': load('n'); break;
					case 'm': load('m'); break;
					// default:
				}

				*/

				//var vowel_sound = 

				sample.playbackRate.value = 0.9 + Math.random() * 0.2;

				sample[sample.start ? 'start' : 'noteOn'](waapi.currentTime + i * delay + Math.random() * 0.1);
			}
		}

		playback();
	</script>
</body>
</html>